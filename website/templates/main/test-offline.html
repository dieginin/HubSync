{% extends "base.html" %}

{% block title %}Offline Test - HubSync{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-body">
        <h1 class="card-title">🧪 Offline Functionality Test - HubSync</h1>

        <div id="connection-status" class="alert mb-3" role="alert">
            Checking connection status...
        </div>

        <h2 class="h4 mb-3">🔧 Testing Instructions:</h2>
        <ol class="mb-4">
            <li><strong>Register Service Worker:</strong> Open DevTools (F12) and verify that the Service Worker is
                registered correctly in the "Application" > "Service Workers" tab</li>
            <li><strong>Simulate disconnection:</strong> In DevTools, go to "Network" and check "Offline"</li>
            <li><strong>Navigate:</strong> Try to navigate to any page of the application</li>
            <li><strong>Expected result:</strong> You should see HubSync's custom offline page</li>
        </ol>

        <h2 class="h4 mb-3">🛠️ Test Controls:</h2>
        <div class="mb-4">
            <button class="btn btn-primary me-2 mb-2" onclick="testOfflinePage()">📄 View offline page</button>
            <button class="btn btn-secondary me-2 mb-2" onclick="testServiceWorker()">⚙️ Check Service Worker</button>
            <button class="btn btn-warning me-2 mb-2" onclick="simulateOffline()">📡 Simulate offline</button>
            <button class="btn btn-outline-primary mb-2" onclick="window.location.reload()">🔄 Reload page</button>
        </div>

        <h2 class="h4 mb-3">📊 Service Worker Status:</h2>
        <div id="sw-status" class="alert alert-info">Checking...</div>

        <h2 class="h4 mb-3">📝 Technical Notes:</h2>
        <ul class="list-unstyled">
            <li class="mb-2">✅ The offline page is a self-contained static HTML file</li>
            <li class="mb-2">✅ The Service Worker automatically caches the offline page</li>
            <li class="mb-2">✅ Automatic reconnection detection every 5 seconds</li>
            <li class="mb-2">✅ Fallback for unavailable images</li>
            <li class="mb-2">✅ Smart caching of static resources</li>
            <li class="mb-2">✅ Theme detection works offline (respects system preferences)</li>
        </ul>
    </div>
</div>

<script>
    // Check connection status
    function updateConnectionStatus() {
        const status = document.getElementById('connection-status');
        if (navigator.onLine) {
            status.className = 'alert alert-success mb-3';
            status.textContent = '🟢 Connected to Internet';
        } else {
            status.className = 'alert alert-danger mb-3';
            status.textContent = '🔴 No Internet connection';
        }
    }

    // Check Service Worker
    function testServiceWorker() {
        const swStatus = document.getElementById('sw-status');
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                if (registrations.length > 0) {
                    swStatus.className = 'alert alert-success';
                    swStatus.innerHTML = `
                        ✅ Service Worker registered successfully<br>
                        📍 Scope: ${registrations[0].scope}<br>
                        🔄 Status: ${registrations[0].active ? 'Active' : 'Inactive'}<br>
                        🗄️ Cache: hubsync-cache-v5
                    `;
                } else {
                    swStatus.className = 'alert alert-warning';
                    swStatus.innerHTML = '⚠️ No Service Workers registered';
                }
            });
        } else {
            swStatus.className = 'alert alert-danger';
            swStatus.innerHTML = '❌ Service Worker not supported in this browser';
        }
    }

    // Show offline page directly
    function testOfflinePage() {
        window.open('/static/offline.html', '_blank');
    }

    // Simulate offline (only shows instructions)
    function simulateOffline() {
        alert(`To simulate offline mode:

1. Open DevTools (F12)
2. Go to the "Network" tab
3. Check the "Offline" checkbox
4. Navigate to any page

The offline page will appear automatically!`);
    }

    // Initialize
    updateConnectionStatus();
    testServiceWorker();

    // Listen to connection changes
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);

    // Update status every 5 seconds
    setInterval(updateConnectionStatus, 5000);
</script>
{% endblock %}